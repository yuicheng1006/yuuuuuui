name: Deploy to EC2 with Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem
      
      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e
            
            echo 'ğŸ”§ ä¿®æ­£ç›®éŒ„æ¬Šé™...'
            sudo chown -R ubuntu:ubuntu /var/www/app
            
            echo 'ğŸ“‚ é€²å…¥å°ˆæ¡ˆç›®éŒ„...'
            cd /var/www/app || exit 1
            
            echo 'ğŸ”„ Pull æœ€æ–°ç¨‹å¼ç¢¼...'
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            
            echo 'ğŸ›‘ åœæ­¢èˆŠå®¹å™¨...'
            docker compose down || true
            
            echo 'ğŸ³ å»ºç«‹ä¸¦å•Ÿå‹•æ–°å®¹å™¨...'
            docker compose up -d --build
            
            echo 'â³ ç­‰å¾…å®¹å™¨å•Ÿå‹•...'
            sleep 5
            
            echo 'âœ… æª¢æŸ¥å®¹å™¨ç‹€æ…‹...'
            docker compose ps
            docker compose logs --tail=20 web
            
            echo 'ğŸ§¹ æ¸…ç†èˆŠçš„ Docker è³‡æº...'
            docker image prune -af
            docker container prune -f
            docker volume prune -f
            
            echo 'ğŸ”„ é‡è¼‰ Nginx (å¦‚æœæœ‰)...'
            sudo systemctl reload nginx || true
            
            echo 'âœ¨ éƒ¨ç½²å®Œæˆï¼'
          "
      
      - name: Clean up SSH key
        if: always()
        run: rm -f key.pem
