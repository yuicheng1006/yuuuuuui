name: Deploy to EC2 with Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ å–å¾—ç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2ï¸âƒ£ è¨­å®š SSH key
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem
      
      # 3ï¸âƒ£ SSH éƒ¨ç½²åˆ° EC2
      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e
            
            echo 'ğŸ”§ ä¿®æ­£å°ˆæ¡ˆç›®éŒ„æ¬Šé™...'
            sudo chown -R ubuntu:ubuntu /var/www/app
            
            echo 'ğŸ›‘ åœæ­¢èˆŠå®¹å™¨...'
            cd /var/www/app || exit 1
            docker compose down || true
            
            echo 'ğŸ§¹ æ¸…ç† Docker èˆŠè³‡æº...'
            docker system prune -a --volumes --force
            docker builder prune --all --force
            
            echo 'ğŸ§¹ æ¸…ç†ç³»çµ±è³‡æº...'
            sudo apt-get clean
            sudo apt-get autoremove --purge -y
            sudo journalctl --vacuum-time=3d
            sudo rm -rf /tmp/*
            
            echo 'ğŸ“‚ æ‹‰æœ€æ–°ç¨‹å¼ç¢¼...'
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            
            echo 'ğŸ³ å»ºç«‹ä¸¦å•Ÿå‹•æ–°å®¹å™¨...'
            docker compose up -d --build
            
            echo 'âœ… æª¢æŸ¥å®¹å™¨ç‹€æ…‹...'
            docker compose ps
            docker compose logs --tail=20 web
            
            echo 'ğŸ”„ æ¸…ç†å¤šé¤˜ Dockerï¼ˆä¸å½±éŸ¿æ–° buildï¼‰...'
            docker image prune -af
            docker container prune -f
            docker volume prune -f
            
            echo 'ğŸ”„ é‡è¼‰ Nginx (å¦‚æœæœ‰)...'
            sudo systemctl reload nginx || true
            
            echo 'âœ¨ éƒ¨ç½²å®Œæˆï¼'
          "
      
      # 4ï¸âƒ£ æ¸…ç†æœ¬åœ° GitHub Action ç”¨çš„ SSH key
      - name: Clean up SSH key
        if: always()
        run: rm -f key.pem
